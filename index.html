<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Thi·ªáp Sinh Nh·∫≠t ‚ù§Ô∏è</title>
<style>
  :root{
    --card-w: 360px;
    --card-h: 520px;
    --accent1:#ff6fa3;
    --accent2:#ffd36e;
    --accent3:#79d4ff;
    --bg1:#ff9a9e;
    --bg2:#fad0c4;
  }

  /* Page */
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family: "Poppins", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    overflow:hidden;
  }

  /* animated gradient background wrapper */
  .scene {
    width:100%;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }

  /* floating bokeh background */
  .bokeh {
    position:absolute;
    inset:0;
    pointer-events:none;
    background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.06), transparent 10%),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.04), transparent 15%);
    animation: bgShift 10s linear infinite;
    mix-blend-mode: overlay;
  }
  @keyframes bgShift{
    0%{transform:translateY(0)}
    50%{transform:translateY(-30px)}
    100%{transform:translateY(0)}
  }

  /* Card container */
  .cardWrap{
    width:clamp(300px, 88vw, var(--card-w));
    height:clamp(420px, 86vh, var(--card-h));
    perspective:1600px;
    position:relative;
    z-index:5;
  }

  /* 3D card */
  .card {
    width:100%;
    height:100%;
    position:relative;
    transform-style:preserve-3d;
    transition: transform 1s cubic-bezier(.2,.9,.3,1);
    cursor:pointer;
    border-radius:18px;
  }

  .card.open { transform: rotateY(180deg); }

  .panel {
    position:absolute;
    inset:0;
    border-radius:18px;
    backface-visibility:hidden;
    overflow:hidden;
    box-shadow: 0 12px 40px rgba(0,0,0,0.18);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  /* front */
  .front {
    background: linear-gradient(135deg, rgba(255,255,255,0.65), rgba(255,255,255,0.25));
    border: 3px solid rgba(255,255,255,0.5);
    transform: translateZ(40px);
  }

  .title {
    font-size: clamp(1.2rem, 4vw, 2rem);
    color:var(--accent1);
    letter-spacing:2px;
    font-weight:700;
    text-shadow: 0 4px 20px rgba(255,111,163,0.18);
    margin:6px 0 10px;
    animation: glow 1.6s infinite alternate;
  }
  @keyframes glow {
    from { filter:drop-shadow(0 0 6px rgba(255,111,163,0.35)); }
    to { filter:drop-shadow(0 0 20px rgba(255,111,163,0.55)); }
  }

  .front .subtitle { color:#444; font-size:0.96rem; margin-bottom:12px; }

  /* balloons group */
  .balloonGroup {
    width:100%;
    height:180px;
    position:relative;
    pointer-events:none;
  }
  .balloon {
    position:absolute;
    bottom:10px;
    width:56px;
    height:70px;
    border-radius:50%;
    transform-origin:center bottom;
    box-shadow: 0 8px 18px rgba(0,0,0,0.15);
  }
  .string {
    position:absolute;
    bottom:-28px;
    width:2px;
    height:36px;
    background:linear-gradient(#e0e0e0,#bdbdbd);
    left:50%;
    transform:translateX(-50%);
    border-radius:2px;
  }

  /* colors and positions */
  .b1{ left:10%; background:linear-gradient(135deg,var(--accent1),#ffb1d0); animation: floaty 5s ease-in-out infinite; animation-delay:0s;}
  .b2{ left:30%; background:linear-gradient(135deg,var(--accent2),#ffe7a8); animation: floaty 6s ease-in-out infinite; animation-delay:0.6s;}
  .b3{ left:52%; background:linear-gradient(135deg,var(--accent3),#bfeaff); animation: floaty 5.5s ease-in-out infinite; animation-delay:0.3s;}
  .b4{ left:74%; background:linear-gradient(135deg,#a7ffb3,#66d4a6); animation: floaty 6.4s ease-in-out infinite; animation-delay:0.9s;}

  @keyframes floaty{
    0%{ transform: translateY(0) rotate(-4deg) }
    50%{ transform: translateY(-70px) rotate(4deg) }
    100%{ transform: translateY(0) rotate(-4deg) }
  }

  /* inside panel */
  .inside {
    background: linear-gradient(160deg,#fff 0%, #fff7fb 60%);
    transform: rotateY(180deg) translateZ(0px);
    padding:24px;
    align-items:flex-start;
    justify-content:flex-start;
    gap:6px;
  }

  .messageBox{
    width:100%;
    height:100%;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }

  .greeting{
    font-family: "Brush Script MT", "Segoe Script", cursive;
    font-size: clamp(1.4rem, 5vw, 2.2rem);
    color:var(--accent1);
    margin:4px 0 8px;
    opacity:0.98;
  }

  .typed {
    font-size:1rem;
    color:#333;
    line-height:1.5;
    min-height:88px;
    margin-bottom:8px;
  }

  .fromLine{
    margin-top:8px;
    color:var(--accent1);
    font-weight:700;
    text-align:right;
    width:100%;
  }

  /* gift box */
  .giftWrap {
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:20px;
    width:140px;
    height:100px;
    perspective:800px;
    z-index:4;
  }

  .box {
    width:100%;
    height:100%;
    position:relative;
    transform-style:preserve-3d;
    transition: transform 0.9s cubic-bezier(.2,.9,.3,1);
  }

  .lid, .base {
    position:absolute;
    left:0; right:0;
    border-radius:10px;
  }
  .lid {
    top:0;
    height:48%;
    background: linear-gradient(180deg,#ff517e,#ff2d6f);
    transform-origin: top center;
    box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    z-index:3;
  }
  .ribbon {
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
  }
  .ribbon::before{
    content:"";
    position:absolute;
    width:16px; height:60%;
    background:rgba(255,255,255,0.18);
    transform:rotate(10deg);
    border-radius:6px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.12) inset;
  }
  .base {
    bottom:0;
    height:60%;
    background: linear-gradient(180deg,#fff,#ffeef6);
    border: 4px solid rgba(255,111,163,0.12);
    box-shadow: inset 0 6px 14px rgba(255,111,163,0.05);
  }

  .box.open .lid { transform: rotateX(70deg) translateY(-10px); }

  /* hearts floating when clicked */
  .heartBtn {
    position:absolute;
    top:12px;
    right:16px;
    width:48px; height:48px;
    border-radius:50%;
    display:grid;
    place-items:center;
    background:linear-gradient(180deg,#fff,#ffeef6);
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    z-index:6;
  }

  .heartIcon {
    width:22px;height:22px;
    transform:rotate(-45deg);
    background:var(--accent1);
    position:relative;
  }
  .heartIcon::before,.heartIcon::after{
    content:""; position:absolute; width:22px;height:22px;border-radius:50%; background:var(--accent1);
  }
  .heartIcon::before{ top:-11px; left:0 }
  .heartIcon::after{ left:11px; top:0 }

  /* popup message modal */
  .modal {
    position:fixed;
    left:50%; top:50%;
    transform:translate(-50%,-50%) scale(0.9);
    background: #fff;
    padding:16px 20px;
    border-radius:14px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.25);
    z-index:50;
    display:none;
    max-width:90vw;
  }
  .modal.show { display:block; transform:translate(-50%,-50%) scale(1); transition: transform .25s ease; }

  .controls{
    position:absolute;
    left:12px; top:12px;
    display:flex; gap:8px; z-index:6;
  }

  .ctlBtn{
    padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.7); border:none; cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,0.08);
    font-weight:600;
  }

  .photo {
    width:92px; height:92px; border-radius:10px; object-fit:cover;
    border:3px solid rgba(255,255,255,0.6);
    box-shadow: 0 8px 22px rgba(0,0,0,0.14);
    margin-left:auto;
  }

  /* fireworks canvas overlay */
  canvas#fx{ position: absolute; inset:0; pointer-events:none; z-index:2; }

  /* confetti holder */
  canvas#confetti{ position:absolute; inset:0; pointer-events:none; z-index:3; }

  /* small responsive tweaks */
  @media (max-width:420px){
    .giftWrap{ width:120px; height:88px; bottom:10px }
    .balloon{ width:46px; height:60px }
    .greeting{ font-size:1.6rem }
  }
</style>
</head>
<body>
  <div class="scene" role="application" aria-label="Thi·ªáp sinh nh·∫≠t t∆∞∆°ng t√°c">
    <div class="bokeh" aria-hidden="true"></div>

    <!-- fireworks canvas -->
    <canvas id="fx" width="1600" height="900" aria-hidden="true"></canvas>
    <!-- confetti -->
    <canvas id="confetti" width="1600" height="900" aria-hidden="true"></canvas>

    <div class="cardWrap">
      <div class="controls" aria-hidden="false">
        <button class="ctlBtn" id="playMusicBtn" title="Ph√°t nh·∫°c">üîä Nh·∫°c</button>
        <button class="ctlBtn" id="fireBtn" title="Ph√°o hoa">üéÜ Ph√°o hoa</button>
        <button class="ctlBtn" id="uploadBtn" title="Th√™m ·∫£nh">üì∑ ·∫¢nh</button>
      </div>

      <div class="card" id="card" tabindex="0" role="button" aria-pressed="false" aria-label="Thi·ªáp, b·∫•m ƒë·ªÉ m·ªü / ƒë√≥ng">
        <!-- FRONT -->
        <div class="panel front" id="frontPanel">
          <div style="width:100%;display:flex;align-items:center;gap:12px;">
            <div style="flex:1">
              <div class="title">HAPPY BIRTHDAY!</div>
              <div class="subtitle">M·ªôt ng√†y r·ª±c r·ª° d√†nh ri√™ng cho b·∫°n ‚ú®</div>
            </div>
            <img src="" alt="·∫¢nh ng∆∞·ªùi ƒë∆∞·ª£c ch√∫c" id="avatar" class="photo" style="display:none">
          </div>

          <div class="balloonGroup" aria-hidden="true">
            <div class="balloon b1"><div class="string"></div></div>
            <div class="balloon b2"><div class="string"></div></div>
            <div class="balloon b3"><div class="string"></div></div>
            <div class="balloon b4"><div class="string"></div></div>
          </div>

          <!-- floating heart button -->
          <div class="heartBtn" id="heartBtn" role="button" aria-label="G·ª≠i tr√°i tim">
            <div class="heartIcon" aria-hidden="true"></div>
          </div>

          <!-- gift -->
          <div class="giftWrap" id="giftWrap" aria-hidden="true">
            <div class="box" id="box">
              <div class="lid"></div>
              <div class="base"></div>
              <div class="ribbon"></div>
            </div>
          </div>
        </div>

        <!-- INSIDE -->
        <div class="panel inside" id="insidePanel">
          <div class="messageBox">
            <div class="greeting">Ch√∫c m·ª´ng sinh nh·∫≠t!</div>
            <div class="typed" id="typedText" aria-live="polite"></div>
            <div class="fromLine">‚Äî Ng∆∞·ªùi b·∫°n th√¢n</div>
          </div>
        </div>
      </div>

      <!-- modal small -->
      <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div id="modalContent">
          <h3 style="margin:0;color:var(--accent1)">üéâ Surprise!</h3>
          <p style="margin:.6rem 0 0">Ch√∫c b·∫°n m·ªôt nƒÉm m·ªõi c·ªßa tu·ªïi m·ªõi th·∫≠t nhi·ªÅu may m·∫Øn, y√™u th∆∞∆°ng v√† ti·∫øng c∆∞·ªùi. Nh·∫•n "OK" ƒë·ªÉ ti·∫øp t·ª•c nh√© üíñ</p>
          <div style="text-align:right;margin-top:10px">
            <button class="ctlBtn" id="okModal">OK</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* =========================
   Utilities & DOM refs
   ========================= */
const card = document.getElementById('card');
const box = document.getElementById('box');
const giftWrap = document.getElementById('giftWrap');
const heartBtn = document.getElementById('heartBtn');
const typedText = document.getElementById('typedText');
const playMusicBtn = document.getElementById('playMusicBtn');
const fireBtn = document.getElementById('fireBtn');
const uploadBtn = document.getElementById('uploadBtn');
const avatar = document.getElementById('avatar');
const modal = document.getElementById('modal');
const okModal = document.getElementById('okModal');

/* =========================
   Card open/close (3D)
   ========================= */
card.addEventListener('click', (e)=>{
  // ignore clicks on control buttons overlay (they are outside card content area)
  if (e.target.closest('.ctlBtn')) return;
  card.classList.toggle('open');
  card.setAttribute('aria-pressed', card.classList.contains('open'));
  // when opened, start typing and fireworks/confetti automatically
  if(card.classList.contains('open')){
    startTyping();
    startConfettiBurst();
    setTimeout(()=>startFireworks(6), 400);
  }
});

/* keyboard accessible (Enter/Space) */
card.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' || e.key===' ') { e.preventDefault(); card.click(); }
});

/* =========================
   Typing effect (multi-line)
   ========================= */
const messages = [
  "Dear Friend,",
  "H√¥m nay l√† ng√†y c·ªßa b·∫°n ‚Äî ch√∫c b·∫°n lu√¥n kh·ªèe m·∫°nh, ng·∫≠p tr√†n ni·ªÅm vui v√† ƒë·∫°t m·ªçi ∆∞·ªõc m∆°.",
  "C·∫£m ∆°n v√¨ ƒë√£ l√† b·∫°n, v√¨ nh·ªØng kho·∫£nh kh·∫Øc c∆∞·ªùi v√† c·∫£ nh·ªØng l√∫c c√πng nhau ƒëi qua kh√≥ khƒÉn.",
  "Ch√∫c m·ª´ng sinh nh·∫≠t! üéÇ‚ú®"
];

let typingIndex = 0;
let charIndex = 0;
let typingTimer = null;

function startTyping(){
  typedText.innerHTML = '';
  typingIndex = 0;
  charIndex = 0;
  typeNextLine();
}

function typeNextLine(){
  if(typingIndex >= messages.length) return;
  const line = messages[typingIndex];
  charIndex = 0;
  typedText.innerHTML += '<div class="line"></div>';
  const lineNode = typedText.querySelectorAll('.line')[typingIndex];
  typingTimer = setInterval(()=>{
    if(charIndex < line.length){
      lineNode.textContent += line[charIndex++];
      // occasional sparkle effect
      if(Math.random() < 0.06) createSpark(lineNode);
    } else {
      clearInterval(typingTimer);
      typingIndex++;
      setTimeout(typeNextLine, 700);
    }
  }, 36);
}

function createSpark(node){
  // quick emoji sparkle add and remove
  const span = document.createElement('span');
  span.textContent = ' ‚ú®';
  node.appendChild(span);
  setTimeout(()=> span.remove(), 500);
}

/* =========================
   Heart particles when pressing heartBtn
   ========================= */
heartBtn.addEventListener('click', (e)=>{
  spawnHearts(e.clientX, e.clientY);
});

function spawnHearts(x,y){
  for(let i=0;i<12;i++){
    const el = document.createElement('div');
    el.style.position='fixed';
    el.style.left=(x-10 + (Math.random()-0.5)*80)+'px';
    el.style.top=(y-10 + (Math.random()-0.5)*80)+'px';
    el.style.width='18px'; el.style.height='18px';
    el.style.background='var(--accent1)';
    el.style.transform='rotate(-45deg)';
    el.style.zIndex=999;
    el.style.borderRadius='3px';
    el.style.opacity=1;
    el.style.pointerEvents='none';
    el.innerHTML = '';
    // create heart by pseudo using before/after not possible here, so use an emoji
    el.textContent='‚ù§';
    el.style.fontSize='18px';
    document.body.appendChild(el);
    // animate
    const dx=(Math.random()-0.5)*120;
    const dy=-150 - Math.random()*120;
    el.animate([
      { transform:`translate(0,0) scale(1)`, opacity:1 },
      { transform:`translate(${dx}px,${dy}px) scale(.8)`, opacity:0 }
    ], { duration: 1200+Math.random()*800, easing:'cubic-bezier(.2,.9,.3,1)'});
    setTimeout(()=> el.remove(), 2000);
  }
}

/* =========================
   Gift open -> release balloons + show modal + play melody
   ========================= */
giftWrap.addEventListener('click', (e)=>{
  box.classList.toggle('open');
  if(box.classList.contains('open')){
    releaseBalloons();
    showModal();
    startMelody();
  }
});

function releaseBalloons(){
  // animate balloons to fly up from gift location
  const group = document.querySelector('.balloonGroup');
  const balloons = group.querySelectorAll('.balloon');
  balloons.forEach((b, idx)=>{
    const js = b.animate([
      { transform:'translateY(0) scale(1)', opacity:1 },
      { transform:`translateY(-520px) translateX(${(idx-1.5)*40}px) scale(1.06)`, opacity:0.95 }
    ], { duration: 2400 + idx*200, easing:'cubic-bezier(.2,.9,.3,1)'});
    js.onfinish = ()=> { /* optional cleanup */ };
  });
}

/* modal */
function showModal(){
  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');
}
okModal.addEventListener('click', ()=>{
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
});

/* =========================
   Upload avatar support
   ========================= */
uploadBtn.addEventListener('click', ()=>{
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='image/*';
  inp.onchange = async (ev)=>{
    const f = ev.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    avatar.src = url; avatar.style.display='block';
  };
  inp.click();
});

/* =========================
   Fireworks canvas
   ========================= */
const fx = document.getElementById('fx');
const fxCtx = fx.getContext('2d');

function resizeCanvases(){
  const w = window.innerWidth, h = window.innerHeight;
  fx.width = w; fx.height = h;
  confettiCanvas.width = w; confettiCanvas.height = h;
}
window.addEventListener('resize', resizeCanvases);
resizeCanvases();

let fireworks = [];
function startFireworks(count=8){
  for(let i=0;i<count;i++){
    setTimeout(()=> fireworks.push(new Firework()), i*220);
  }
  if(!fx.looping) loopFx();
}
function Firework(){
  this.x = Math.random()*fx.width*0.8 + fx.width*0.1;
  this.y = fx.height + 20;
  this.targetY = Math.random()*fx.height*0.45 + fx.height*0.15;
  this.vx = (Math.random()-0.5)*2;
  this.vy = -8 - Math.random()*5;
  this.exploded=false;
}
Firework.prototype.update = function(i, dt){
  this.x += this.vx; this.y += this.vy;
  this.vy += 0.18; // gravity
  // if reached target
  if(!this.exploded && this.vy >= -1 && this.y < this.targetY+20){
    this.exploded = true;
    explode(this.x, this.y);
    fireworks.splice(i,1);
  }
};
function explode(x,y){
  const count = 22 + Math.round(Math.random()*40);
  for(let i=0;i<count;i++){
    particles.push(new Particle(x,y));
  }
  // small flash
  fxCtx.fillStyle = 'rgba(255,255,255,0.12)';
  fxCtx.beginPath(); fxCtx.arc(x,y,40,0,Math.PI*2); fxCtx.fill();
}

/* particles for explosion */
let particles = [];
function Particle(x,y){
  this.x = x; this.y = y;
  const ang = Math.random()*Math.PI*2;
  const sp = 2 + Math.random()*6;
  this.vx = Math.cos(ang)*sp;
  this.vy = Math.sin(ang)*sp;
  this.life = 70 + Math.random()*40;
  this.age = 0;
  this.color = `hsl(${Math.floor(Math.random()*360)}deg 80% 60%)`;
}
Particle.prototype.update = function(i){
  this.x += this.vx; this.y += this.vy;
  this.vx *= 0.99; this.vy *= 0.99;
  this.vy += 0.06; // gravity
  this.age++;
  if(this.age > this.life) particles.splice(i,1);
};

/* animation loop */
fx.looping = false;
function loopFx(){
  fx.looping = true;
  let last = performance.now();
  (function frame(t){
    const dt = t - last; last = t;
    fxCtx.clearRect(0,0,fx.width,fx.height);
    // update fireworks
    for(let i=fireworks.length-1;i>=0;i--) fireworks[i].update(i,dt);
    // update particles
    for(let i=particles.length-1;i>=0;i--){
      particles[i].update(i);
      const p = particles[i];
      const alpha = 1 - p.age/p.life;
      fxCtx.beginPath();
      fxCtx.fillStyle = p.color;
      fxCtx.globalAlpha = alpha;
      fxCtx.arc(p.x,p.y, 2.4, 0, Math.PI*2);
      fxCtx.fill();
    }
    fxCtx.globalAlpha = 1;
    if(fireworks.length || particles.length) requestAnimationFrame(frame);
    else fx.looping = false;
  })();
}

/* manual fire button */
fireBtn.addEventListener('click', ()=> startFireworks(10));

/* =========================
   Confetti (when opening card)
   ========================= */
const confettiCanvas = document.getElementById('confetti');
const confettiCtx = confettiCanvas.getContext('2d');
let confettiPieces = [];

function startConfettiBurst(){
  for(let i=0;i<120;i++){
    confettiPieces.push(new ConfettiPiece());
  }
  if(!confettiLooping) loopConfetti();
}

function ConfettiPiece(){
  this.x = Math.random()*confettiCanvas.width;
  this.y = -10 - Math.random()*200;
  this.vx = (Math.random()-0.5)*6;
  this.vy = 2 + Math.random()*5;
  this.size = 6 + Math.random()*8;
  this.rot = Math.random()*360;
  this.omega = (Math.random()-0.5)*0.2;
  this.color = ['#ff6fa3','#ffd36e','#79d4ff','#a7ffb3'][Math.floor(Math.random()*4)];
  this.life = 280 + Math.random()*200;
  this.age = 0;
}
ConfettiPiece.prototype.update = function(i){
  this.x += this.vx; this.y += this.vy;
  this.vy += 0.02;
  this.rot += this.omega;
  this.age++;
  if(this.y > confettiCanvas.height+20 || this.age > this.life) confettiPieces.splice(i,1);
};

let confettiLooping=false;
function loopConfetti(){
  confettiLooping=true;
  (function f(){
    confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    for(let i=confettiPieces.length-1;i>=0;i--){
      confettiPieces[i].update(i);
      const c = confettiPieces[i];
      confettiCtx.save();
      confettiCtx.translate(c.x,c.y);
      confettiCtx.rotate(c.rot);
      confettiCtx.fillStyle = c.color;
      confettiCtx.fillRect(-c.size/2, -c.size/2, c.size, c.size*0.6);
      confettiCtx.restore();
    }
    if(confettiPieces.length) requestAnimationFrame(f);
    else confettiLooping=false;
  })();
}

/* =========================
   Simple melody generator (Happy Birthday-ish) via WebAudio
   ========================= */
let audioCtx = null;
let musicPlaying = false;
playMusicBtn.addEventListener('click', ()=>{
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(musicPlaying){ stopMelody(); playMusicBtn.textContent = 'üîä Nh·∫°c'; }
  else { startMelody(); playMusicBtn.textContent = 'üîá T·∫Øt'; }
});

function startMelody(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  musicPlaying = true;
  // sequence of notes (Hz) and durations (ms) approximating "Happy Birthday"
  const seq = [
    [263,300],[263,300],[295,600],[263,600],[349,600],[330,1200],
    [263,300],[263,300],[295,600],[263,600],[392,600],[349,1200],
    [263,300],[263,300],[523,600],[440,600],[349,600],[330,600],[295,1200],
    [466,300],[466,300],[440,600],[349,600],[392,600],[349,1200]
  ];
  let t = audioCtx.currentTime + 0.05;
  const master = audioCtx.createGain(); master.connect(audioCtx.destination); master.gain.value = 0.12;
  seq.forEach(([freq,dur],i)=>{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.value = 0;
    o.connect(g); g.connect(master);
    o.start(t);
    g.gain.linearRampToValueAtTime(0.12, t + 0.01);
    g.gain.linearRampToValueAtTime(0.0001, t + dur/1000 - 0.02);
    o.stop(t + dur/1000);
    t += dur/1000;
  });
  // set a flag to stop (we just play once)
  setTimeout(()=> musicPlaying=false, (seq.reduce((a,b)=>a+b[1],0))+200);
}

function stopMelody(){ /* simple stop by closing context */
  if(audioCtx) { try{ audioCtx.close(); }catch(e){} audioCtx=null; musicPlaying=false; }
}

/* =========================
   Auto small confetti when opening (already triggered)
   ========================= */

/* =========================
   Accessibility: reduce motion preference
   ========================= */
const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
if(prefersReduced){
  document.querySelectorAll('*').forEach(el=>{
    el.style.transition='none';
    el.style.animation='none';
  });
}

/* =========================
   Init states
   ========================= */
(function init(){
  // show gift clickable hint
  giftWrap.style.display = 'block';
  // small entrance animation
  setTimeout(()=> document.querySelector('.card').style.transform += ' translateY(-6px)', 80);
})();

/* =========================
   small helper to trigger confetti when card open
   ========================= */
// already wired in card open: startConfettiBurst()

/* =========================
   End script
   ========================= */
</script>
</body>
</html>
